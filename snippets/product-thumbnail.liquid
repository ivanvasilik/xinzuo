{% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
{% comment %}
    Renders a product thumbnail with a modal-opener

    Accepts:
    - media: {Object} Product Media object
    - media_count: {Number} Number of media objects
    - position: {String} Position of the media. Used for accessible label.
    - desktop_layout: {String} Layout of the media for desktop.
    - mobile_layout: {String} Layout of the media for mobile.
    - loop: {Boolean} Enable video looping (optional)
    - modal_id: {String} The product modal that will be shown by clicking the thumbnail
    - xr_button: {Boolean} Renders the "View in your space" button (shopify-xr-button) if the media is a 3D Model
    - constrain_to_viewport: {Boolean} Force media height to fit within viewport
    - media_fit: {String} Method ("contain" or "cover") to fit image into container
    - media_width: {Float} The width percentage that the media column occupies on desktop.
    - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)

    Usage:
    {% render 'product-thumbnail',
      media: media,
      position: forloop.index,
      loop: section.settings.enable_video_looping,
      modal_id: section.id
    %}
{% endcomment %}

{%- liquid
    unless lazy_load == false
        assign lazy = 'lazy'
    endunless

    assign desktop_columns = 1
    if desktop_layout == 'columns' and media_count > 1
        assign desktop_columns = 2
    endif

    assign mobile_columns = 1
    if mobile_layout == 'columns' and media_count > 1
        assign mobile_columns = 2
    endif

    if media.media_type == 'image'
        assign image_class = 'image-magnify-' | append: section.settings.image_zoom
    endif
-%}

{%- capture sizes -%}
    (min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 100 | times: media_width | divided_by: desktop_columns | round }}px, (min-width: 990px) calc({{ media_width | times: 100 | divided_by: desktop_columns }}vw - 10rem), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw / {{ mobile_columns }} - 4rem)
{%- endcapture -%}

{%- if media.media_type != 'image' -%}
    {% assign media_fit = "cover" %}
{% endif %}

<div
    class="product-media-container media-type-{{ media.media_type }} media-fit-{{ media_fit }} global-media-settings gradient{% if constrain_to_viewport %} constrain-height{% endif %}"
    style="--ratio: {{ media.aspect_ratio | default: 1.0 }}; --preview-ratio: {{ media.preview_image.aspect_ratio | default: 1.0 }};{%- if media.media_type != 'image' -%}background: transparent;{% endif %}"
>
    <noscript>
        {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
            <span class="product__media-icon motion-reduce quick-add-hidden">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    focusable="false"
                    class="icon icon-play"
                    fill="none"
                    viewBox="0 0 10 14"
                    >
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.48177 0.814643C0.81532 0.448245 0 0.930414 0 1.69094V12.2081C0 12.991 0.858787 13.4702 1.52503 13.0592L10.5398 7.49813C11.1918 7.09588 11.1679 6.13985 10.4965 5.77075L1.48177 0.814643Z" fill="currentColor"/>
                </svg>
            </span>
            <div class="product__media media">
                {{ media.preview_image | image_url: width: 1946 | image_tag:
                    loading: lazy,
                    sizes: sizes,
                    widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
                }}
            </div>
            <a href="{% if media.media_type == 'video' %}{{ media.sources[1].url }}{% else %}{{ media | external_video_url }}{% endif %}" class="product__media-toggle">
                <span class="visually-hidden">video_exit_message</span>
            </a>
        {%- else -%}
            <div class="product__media media">
                {{ media.preview_image | image_url: width: 1946 | image_tag:
                loading: lazy,
                sizes: sizes,
                widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
                }}
            </div>
        {%- endif -%}
    </noscript>

    {%- if media.media_type == 'image' -%}
        <modal-opener class="product__modal-opener product__modal-opener--{{ media.media_type }} no-js-hidden" data-modal="#ProductModal-{{ modal_id }}">
            <span class="product__media-icon motion-reduce quick-add-hidden{% if media.media_type == 'image' %} product__media-icon--{{ section.settings.image_zoom }}{% endif %}" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="27" height="24" viewBox="0 0 27 24" fill="none" class="icon icon-plus">
                    <circle cx="11" cy="11.4541" r="10.25" stroke="black" stroke-width="1.5"/>
                    <path d="M18.5 17.5166L26 23.2041" stroke="black" stroke-width="1.5"/>
                </svg>
            </span>
            <div class="loading-overlay__spinner hidden">
            <svg
                aria-hidden="true"
                focusable="false"
                class="spinner"
                viewBox="0 0 66 66"
                xmlns="http://www.w3.org/2000/svg"
            >
                <circle class="path" fill="none" stroke-width="4" cx="33" cy="33" r="30"></circle>
            </svg>
            </div>
            <div class="product__media media media--transparent">
            {{ media.preview_image | image_url: width: 1946 | image_tag:
                class: image_class,
                loading: lazy,
                sizes: sizes,
                widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
            }}
            </div>
            <button class="product__media-toggle quick-add-hidden product__media-zoom-{{ section.settings.image_zoom }}" type="button" aria-haspopup="dialog" data-media-id="{{ media.id }}">
            <span class="visually-hidden">open_media</span>
            </button>
        </modal-opener>
    {% endif %}

    {%- if media.media_type != 'image' -%}
    
        <div class="product-thumbnail external-video--wrapper">
        {{media | external_video_url: autoplay: true, loop: loop, playlist: media.external_id, controls: false, muted: true, playsinline: true  | external_video_tag: class: video_class, autoplay: true, muted: true, controls: false, playsinline: true, loading: "lazy"}}
        </div>
    {%- endif -%}
</div>
