{% style %}

{% endstyle %}

<div class="section-{{ section.id }}">
    <div class="home-products">
        <h2>{{ section.settings.heading }}</h2>
        <div class="home-grid" id="home-products">
            {% for product in collections.all.products limit: 4 %}
                <div class="product-item">
                    {{ product.title }}
                </div>
            {% endfor %}
        </div>
        <button id="load-more" data-page="1">Load more</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('#load-more');
        const grid = document.querySelector('#home-products');

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.textContent = 'Loading...';

            let page = parseInt(btn.getAttribute('data-page')) + 1;
            const collectionHandle = "{{ section.settings.collection.handle }}";

            try {
            const res = await fetch(`/collections/all.json?page=${page}`);
            const data = await res.json();

            if (!data.products || data.products.length === 0) {
                btn.remove();
                return;
            }

            data.products.slice(0,4).forEach(p => {
                const div = document.createElement('div');
                div.className = 'product-item';
                div.innerHTML = `<a href="${p.url}">
                    <img src="${p.images[0] || ''}" alt="${p.title}">
                    <p>${p.title}</p>
                    </a>`;
                grid.appendChild(div);
            });

            btn.setAttribute('data-page', page);
            btn.disabled = false;
            btn.textContent = 'Load more';

            if (data.products.length < 4) btn.remove();

            } catch(err) {
                console.error(err);
                btn.disabled = false;
                btn.textContent = 'Error';
            }
        });
    });
</script>

{% schema %}
{
    "name": "Home Products",
    "settings": [
        {
            "type": "text",
            "id": "heading",
            "label": "Heading"
        }
    ],
    "presets": [
        {
            "name": "Home Products"
        }
    ]
}
{% endschema %}