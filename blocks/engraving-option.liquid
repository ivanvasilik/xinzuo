<div>
    <p>Engraving option</p>
    <div class="engrave-btns">
        <button type="button" class="engrave-btn" onclick="engrave(0)">Without engraving</button>
        <button type="button" class="engrave-btn" onclick="engrave(1)">Engrave text (+$15)</button>
    </div>
    <div class="engrave-div">
        <span>{{ block.settings.engraving_title }}</span>
        <input type="text" name="properties[Engraving Text]" placeholder="Enter text, e.g.: Chef" id="engravedInput" maxlength="20">
    </div>
</div>

{% style %}
    .engrave-btns {
        display: flex;
    }

    .engrave-div {
        display: none;
    }
{% endstyle %}

<script>
    window.engravingSelected = false;
    window.engravingText = "";
    const engrave = (num) => {
        const engraves = document.querySelectorAll(".engrave-btn");
        const engraveDiv = document.querySelector(".engrave-div");
        if (engraves.length > 0) {
            engraves.forEach(engrave => {
                engrave.classList.remove('active');
            })
            engraves[num].classList.add('active');
        }
        if (engraveDiv) {
            if (num == 0) {
                engraveDiv.style.display = "none";
                window.engravingSelected = false;
            } else {
                engraveDiv.style.display = "block";
                window.engravingSelected = true;
            }
        }
    }

    document.querySelector('#engravedInput').addEventListener("input", e => {
        window.engravingText = e.target.value;
    });

    {% comment %} document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector('form[data-type="add-to-cart-form"]');
        if (!form) return;

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            event.stopImmediatePropagation();
            event.stopPropagation();

            const variantId = form.querySelector("[name='id']").value;
            const quantity = Number(form.querySelector("[name='quantity']")?.value || 1);

            await fetch("/cart/add.js", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: variantId,
                    quantity: quantity,
                    properties: window.engravingSelected
                        ? { "Engraving Text": window.engravingText }
                        : {}
                })
            });

            if (window.engravingSelected && window.engravingText !== "") {
                await fetch("/cart/add.js", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: FEE_VARIANT_ID,
                        quantity: quantity,
                        properties: {
                            "Engraving Text": window.engravingText
                        }
                    })
                });
            }

            window.dispatchEvent(new CustomEvent("cart:refresh"));
        }, { capture: true });
    }) {% endcomment %}
</script>

{% schema %}
{
    "name": "Engraving option",
    "tag": null,
    "settings": [
        {
            "type": "richtext",
            "id": "engraving_title",
            "label": "Engraving title"
        }
    ]
}
{% endschema %}