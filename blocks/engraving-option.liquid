<div class="engraving-container" {{ block.shopify_attributes }}>
    <!-- Main Toggle: No Engraving / Add Engraving -->
    <div class="engraving-toggle-group">
        <button type="button" class="engraving-toggle-btn selected" id="btn-no-engraving">
            No Engraving
        </button>
        <button type="button" class="engraving-toggle-btn" id="btn-add-engraving">
            Add Engraving
        </button>
    </div>
    
    <!-- Hidden checkbox for form compatibility -->
    <input type="checkbox" id="engrave-state" class="engraving-checkbox-hidden" style="display: none;">
    
    <div class="engraving-content" id="engrave-div" style="display: none;">
        <!-- Line Count Toggle: One Line / Two Lines -->
        <div class="engraving-line-toggle">
            <button type="button" class="engraving-line-btn selected" id="btn-one-line" data-lines="one">
                <span class="line-btn-title">One Line</span>
                <span class="line-btn-price">+${{ product.metafields.custom.knife_num | times: 19 }}</span>
            </button>
            <button type="button" class="engraving-line-btn" id="btn-two-lines" data-lines="two">
                <span class="line-btn-title">Two Lines</span>
                <span class="line-btn-price">+${{ product.metafields.custom.knife_num | times: 29 }}</span>
            </button>
        </div>
        
        <!-- Hidden radios for form compatibility -->
        <input type="radio" name="engrave-radio" id="engrave-one" value="one-line" checked style="display: none;">
        <input type="radio" name="engrave-radio" id="engrave-two" value="two-line" style="display: none;">
        
        <div class="engraving-inputs">
            <div class="input-group">
                <input 
                    type="text" 
                    name="properties[Engraving Text]" 
                    placeholder="Enter text, e.g.: Chef" 
                    id="engravedInput" 
                    class="engraving-input"
                    maxlength="{{ block.settings.engraving_length }}"
                    autocomplete="off"
                >
                <span class="input-count" id="count-line1">0/{{ block.settings.engraving_length }}</span>
            </div>
            <div class="input-group" id="input-group-2" style="display: none;">
                <input 
                    type="text" 
                    name="properties[Engraving Text2]" 
                    placeholder="Second line, e.g.: Master Chef" 
                    id="engravedInput2" 
                    class="engraving-input"
                    maxlength="{{ block.settings.engraving_length }}"
                    autocomplete="off"
                >
                <span class="input-count" id="count-line2">0/{{ block.settings.engraving_length }}</span>
            </div>
        </div>
        
        <p class="engraving-note">{{ block.settings.engraving_text }}</p>
    </div>
</div>

{% style %}
    .engraving-container {
        margin-top: 16px;
    }

    /* Main Toggle Group: No Engraving / Add Engraving */
    .engraving-toggle-group {
        display: flex;
        gap: 10px;
    }

    .engraving-toggle-btn {
        flex: 1;
        padding: 12px 16px;
        background-color: rgba(41, 42, 51, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #c9c9cc;
        font-family: "Sen", sans-serif;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .engraving-toggle-btn:hover {
        border-color: rgba(255, 255, 255, 0.4);
        color: #ffffff;
    }

    .engraving-toggle-btn.selected {
        border-color: #ffffff;
        color: #ffffff;
        background-color: rgba(255, 255, 255, 0.08);
    }

    /* Content Area */
    .engraving-content {
        padding: 16px;
        background-color: rgba(41, 42, 51, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-top: 12px;
    }

    /* Line Count Toggle: One Line / Two Lines */
    .engraving-line-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
    }

    .engraving-line-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 12px 14px;
        background-color: rgba(41, 42, 51, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .engraving-line-btn:hover {
        border-color: rgba(255, 255, 255, 0.4);
    }

    .engraving-line-btn.selected {
        border-color: #ffffff;
        background-color: rgba(255, 255, 255, 0.08);
    }

    .line-btn-title {
        font-family: "Sen", sans-serif;
        font-weight: 600;
        font-size: 14px;
        color: #ffffff;
        line-height: 1.2;
    }

    .line-btn-price {
        font-family: "Albert Sans", sans-serif;
        font-weight: 400;
        font-size: 13px;
        color: #c9c9cc;
    }

    .engraving-line-btn.selected .line-btn-price {
        color: #ffffff;
    }

    /* Input Fields */
    .engraving-inputs {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    .engraving-input {
        width: 100%;
        padding: 12px 14px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #ffffff;
        font-family: "Albert Sans", sans-serif;
        font-size: 14px;
        transition: border-color 0.3s ease, background-color 0.3s ease;
        outline: none;
    }

    .engraving-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .engraving-input:focus {
        border-color: #ffffff;
        background-color: rgba(255, 255, 255, 0.08);
    }

    .input-count {
        font-family: "Sen", sans-serif;
        font-weight: 600;
        font-size: 11px;
        color: #c9c9cc;
        letter-spacing: 0.5px;
        text-align: right;
    }

    /* Note Text */
    .engraving-note {
        margin: 12px 0 0 0;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-family: "Albert Sans", sans-serif;
        font-weight: 400;
        font-size: 13px;
        color: #c9c9cc;
        line-height: 1.5;
        font-style: italic;
    }

    /* Hover States (Desktop Only) */
    @media (min-width: 1024px) {
        .engraving-checkbox-wrapper:hover .engraving-checkbox-custom {
            border-color: rgba(255, 255, 255, 0.4);
        }

        .engraving-radio-option:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.08);
        }

        .engraving-radio-option:has(input:checked):hover {
            border-color: #ffffff;
        }
    }

    /* Mobile Active States */
    @media (max-width: 1023px) {
        .engraving-checkbox-wrapper:active .engraving-checkbox-custom {
            transform: scale(0.95);
        }

        .engraving-radio-option:active {
            transform: scale(0.98);
        }
    }

    /* Tablet & Desktop Adjustments */
    @media (min-width: 750px) {
        .engraving-content {
            padding: 20px;
        }

        .engraving-label {
            font-size: 16px;
        }

        .radio-title {
            font-size: 15px;
        }

        .engraving-input {
            font-size: 15px;
        }

        .engraving-note {
            font-size: 14px;
        }
    }
{% endstyle %}

<script>
    (function() {
        // Global state
        window.engravingSelected = false;
        window.engravingSecondSelected = false;
        window.engravingText = "";
        window.engravingText2 = "";
        window.knife_num = {{ product.metafields.custom.knife_num }};

        // DOM elements
        const engraveDiv = document.getElementById("engrave-div");
        const engraveCheck = document.getElementById("engrave-state");
        const engraveRadio = document.getElementById("engrave-one");
        const engraveSecondRadio = document.getElementById("engrave-two");
        const engraveInput = document.getElementById("engravedInput");
        const engraveSecondInput = document.getElementById("engravedInput2");
        const countLine1 = document.getElementById("count-line1");
        const countLine2 = document.getElementById("count-line2");
        const inputGroup2 = document.getElementById("input-group-2");
        
        // New button elements
        const btnNoEngraving = document.getElementById("btn-no-engraving");
        const btnAddEngraving = document.getElementById("btn-add-engraving");
        const btnOneLine = document.getElementById("btn-one-line");
        const btnTwoLines = document.getElementById("btn-two-lines");

        if (!engraveDiv || !engraveCheck || !engraveInput || !engraveSecondInput) {
            console.warn('Engraving elements not found');
            return;
        }

        // Helper to reset engraving state
        function resetEngraving() {
            const maxLength = {{ block.settings.engraving_length }};
            engraveDiv.style.display = "none";
            engraveCheck.checked = false;
            window.engravingSelected = false;
            window.engravingSecondSelected = false;
            window.engravingText = "";
            window.engravingText2 = "";
            engraveInput.value = "";
            engraveSecondInput.value = "";
            if (countLine1) countLine1.textContent = `0/${maxLength}`;
            if (countLine2) countLine2.textContent = `0/${maxLength}`;
            engraveRadio.checked = true;
            engraveSecondRadio.checked = false;
            inputGroup2.style.display = "none";
            
            // Reset line buttons
            btnOneLine.classList.add('selected');
            btnTwoLines.classList.remove('selected');
        }

        // No Engraving button
        btnNoEngraving.addEventListener("click", () => {
            btnNoEngraving.classList.add('selected');
            btnAddEngraving.classList.remove('selected');
            resetEngraving();
        });

        // Add Engraving button
        btnAddEngraving.addEventListener("click", () => {
            btnAddEngraving.classList.add('selected');
            btnNoEngraving.classList.remove('selected');
            engraveDiv.style.display = "block";
            engraveCheck.checked = true;
            window.engravingSelected = true;
            // Focus first input for better UX
            requestAnimationFrame(() => engraveInput.focus());
        });

        // One Line button
        btnOneLine.addEventListener("click", () => {
            btnOneLine.classList.add('selected');
            btnTwoLines.classList.remove('selected');
            engraveRadio.checked = true;
            engraveSecondRadio.checked = false;
            inputGroup2.style.display = "none";
            window.engravingSecondSelected = false;
            window.engravingText2 = "";
            engraveSecondInput.value = "";
            updateCharacterCount();
        });

        // Two Lines button
        btnTwoLines.addEventListener("click", () => {
            btnTwoLines.classList.add('selected');
            btnOneLine.classList.remove('selected');
            engraveSecondRadio.checked = true;
            engraveRadio.checked = false;
            inputGroup2.style.display = "flex";
            window.engravingSecondSelected = true;
            requestAnimationFrame(() => engraveSecondInput.focus());
            updateCharacterCount();
        });

        // Update character count for each line
        function updateCharacterCount() {
            const maxLength = {{ block.settings.engraving_length }};
            
            // Update line 1 counter
            if (countLine1) {
                countLine1.textContent = `${window.engravingText.length}/${maxLength}`;
            }
            
            // Update line 2 counter (if two-line is selected)
            if (countLine2 && window.engravingSecondSelected) {
                countLine2.textContent = `${window.engravingText2.length}/${maxLength}`;
            }
        }

        // First input handler
        engraveInput.addEventListener("input", (e) => {
            window.engravingText = e.target.value;
            updateCharacterCount();
        });

        // Second input handler
        engraveSecondInput.addEventListener("input", (e) => {
            window.engravingText2 = e.target.value;
            updateCharacterCount();
        });
    })();
</script>

{% schema %}
{
    "name": "Engraving option",
    "tag": null,
    "settings": [
        {
            "type": "text",
            "id": "btn1",
            "label": "First Button",
            "default": "Without engraving"
        },
        {
            "type": "text",
            "id": "btn2",
            "label": "Second Button",
            "default": "Engrave text (+$15)"
        },
        {
            "type": "text",
            "id": "engraving_text",
            "label": "Engraving title",
            "default": "Letters, numbers, and basic punctuation only."
        },
        {
            "type": "range",
            "id": "engraving_length",
            "label": "Engraving Length",
            "min": 10,
            "max": 40,
            "default": 20,
            "step": 1
        }
    ]
}
{% endschema %}